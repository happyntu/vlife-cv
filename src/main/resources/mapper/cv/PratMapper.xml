<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vlife.cv.rate.PratMapper">

    <!-- ===== SQL Fragment Reuse ===== -->

    <sql id="planRateColumns">
        PLAN_CODE as planCode,
        VERSION as version,
        RATE_SEX as rateSex,
        RATE_SUB_1 as rateSub1,
        RATE_SUB_2 as rateSub2,
        RATE_AGE as rateAge,
        ANNUAL_PREM as annualPrem,
        ANNUAL_PREM2 as annualPrem2,
        EMPLOYEE_DISC as employeeDisc,
        LOADING_RATE2 as loadingRate2
    </sql>

    <sql id="primaryKeyCondition">
        PLAN_CODE = #{planCode}
        AND VERSION = #{version}
        AND RATE_SEX = #{rateSex}
        AND RATE_SUB_1 = #{rateSub1}
        AND RATE_SUB_2 = #{rateSub2}
        AND RATE_AGE = #{rateAge}
    </sql>

    <!-- ===== Query Operations ===== -->

    <!-- Find by primary key (V3: f99_get_prat_1) -->
    <select id="findByPrimaryKey" resultType="com.vlife.cv.rate.PlanRate">
        SELECT <include refid="planRateColumns"/>
        FROM CV.PRAT
        WHERE <include refid="primaryKeyCondition"/>
    </select>

    <!-- ===== Count Operations ===== -->

    <!-- Fixed condition count (V3: f99_get_prat_cnt) -->
    <select id="countByPrimaryKey" resultType="int">
        SELECT COUNT(1)
        FROM CV.PRAT
        WHERE <include refid="primaryKeyCondition"/>
    </select>

    <!-- Dynamic condition count (V3: f99_get_prat_cnt_2) -->
    <!--
        V3 uses EXECUTE IMMEDIATE dynamic SQL, building WHERE clause based on NULL values.
        V4 uses MyBatis <if> dynamic XML for safety and readability.
        V3 logic: rateAge = 999 means "no age limit".
        V4 logic: rateAge = null means "no age limit".
    -->
    <select id="countDynamic" resultType="int">
        SELECT COUNT(1)
        FROM CV.PRAT
        WHERE PLAN_CODE = #{planCode}
          AND VERSION = #{version}
          <if test="rateSex != null">
              AND RATE_SEX = #{rateSex}
          </if>
          <if test="rateSub1 != null">
              AND RATE_SUB_1 = #{rateSub1}
          </if>
          <if test="rateSub2 != null">
              AND RATE_SUB_2 = #{rateSub2}
          </if>
          <if test="rateAge != null">
              AND RATE_AGE = #{rateAge}
          </if>
    </select>

    <!-- ===== Insert Operation ===== -->

    <!-- Insert new rate record (V3: f99_insert_prat) -->
    <insert id="insert" parameterType="com.vlife.cv.rate.PlanRate">
        INSERT INTO CV.PRAT (
            PLAN_CODE, VERSION, RATE_SEX, RATE_SUB_1, RATE_SUB_2, RATE_AGE,
            ANNUAL_PREM, ANNUAL_PREM2, EMPLOYEE_DISC, LOADING_RATE2
        ) VALUES (
            #{planCode}, #{version}, #{rateSex}, #{rateSub1}, #{rateSub2}, #{rateAge},
            #{annualPrem}, #{annualPrem2,jdbcType=NUMERIC}, #{employeeDisc,jdbcType=NUMERIC}, #{loadingRate2,jdbcType=NUMERIC}
        )
    </insert>

    <!-- ===== Update Operation ===== -->

    <!-- Update by primary key (V3: f99_update_prat) -->
    <update id="update">
        UPDATE CV.PRAT
        SET ANNUAL_PREM = #{entity.annualPrem},
            ANNUAL_PREM2 = #{entity.annualPrem2,jdbcType=NUMERIC},
            EMPLOYEE_DISC = #{entity.employeeDisc,jdbcType=NUMERIC},
            LOADING_RATE2 = #{entity.loadingRate2,jdbcType=NUMERIC}
        WHERE PLAN_CODE = #{key.planCode}
          AND VERSION = #{key.version}
          AND RATE_SEX = #{key.rateSex}
          AND RATE_SUB_1 = #{key.rateSub1}
          AND RATE_SUB_2 = #{key.rateSub2}
          AND RATE_AGE = #{key.rateAge}
    </update>

    <!-- ===== Delete Operation ===== -->

    <!-- Delete by primary key (V3: f99_delete_prat) -->
    <delete id="deleteByPrimaryKey">
        DELETE FROM CV.PRAT
        WHERE <include refid="primaryKeyCondition"/>
    </delete>

</mapper>
