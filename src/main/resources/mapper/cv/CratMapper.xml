<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    CratMapper - 佣金率表 MyBatis Mapper

    遵循 ADR-009 規範，SQL 必須明確指定 CV Schema。
    遵循 ADR-016 規範，SQL 集中於 XML 管理。
    遵循 ADR-017 規範，Mapper 名稱對應資料庫表格名稱 (CRAT)。
-->
<mapper namespace="com.vlife.cv.commission.CratMapper">

    <!-- SQL 片段：佣金率欄位對應 -->
    <sql id="commissionRateColumns">
        CRAT_SERIAL as serial,
        COMM_CLASS_CODE as commClassCode,
        COMM_LINE_CODE as commLineCode,
        CRAT_TYPE as cratType,
        PROJ_NO as projectNo,
        STR_DATE as startDate,
        END_DATE as endDate,
        CRAT_KEY1 as cratKey1,
        CRAT_KEY2 as cratKey2,
        COMM_START_YEAR as commStartYear,
        COMM_END_YEAR as commEndYear,
        COMM_START_AGE as commStartAge,
        COMM_END_AGE as commEndAge,
        COMM_START_MODX as commStartModx,
        COMM_END_MODX as commEndModx,
        COMM_RATE as commRate,
        COMM_RATE_ORG as commRateOrg,
        PREM_LIMIT_STR as premLimitStart,
        PREM_LIMIT_END as premLimitEnd
    </sql>

    <!--
        依序號查詢佣金率
    -->
    <select id="findBySerial" resultType="com.vlife.cv.commission.Crat">
        SELECT <include refid="commissionRateColumns"/>
        FROM CV.CRAT
        WHERE CRAT_SERIAL = #{serial}
    </select>

    <!--
        依佣金類別碼查詢佣金率清單
    -->
    <select id="findByClassCode" resultType="com.vlife.cv.commission.Crat">
        SELECT <include refid="commissionRateColumns"/>
        FROM CV.CRAT
        WHERE COMM_CLASS_CODE = #{commClassCode}
        ORDER BY STR_DATE DESC, CRAT_SERIAL
    </select>

    <!--
        查詢指定日期有效的佣金率
    -->
    <select id="findEffectiveRates" resultType="com.vlife.cv.commission.Crat">
        SELECT <include refid="commissionRateColumns"/>
        FROM CV.CRAT
        WHERE COMM_CLASS_CODE = #{commClassCode}
          AND COMM_LINE_CODE = #{commLineCode}
          AND STR_DATE &lt;= #{effectiveDate}
          AND END_DATE &gt;= #{effectiveDate}
        ORDER BY CRAT_TYPE, CRAT_SERIAL
    </select>

    <!--
        依業務線代號查詢所有佣金率類別碼
    -->
    <select id="findClassCodesByLineCode" resultType="java.lang.String">
        SELECT DISTINCT COMM_CLASS_CODE
        FROM CV.CRAT
        WHERE COMM_LINE_CODE = #{commLineCode}
        ORDER BY COMM_CLASS_CODE
    </select>

    <!--
        查詢所有不重複的業務線代號
    -->
    <select id="findAllLineCodes" resultType="java.lang.String">
        SELECT DISTINCT COMM_LINE_CODE
        FROM CV.CRAT
        ORDER BY COMM_LINE_CODE
    </select>

    <!--
        查詢所有不重複的佣金率型態
    -->
    <select id="findAllCratTypes" resultType="java.lang.String">
        SELECT DISTINCT CRAT_TYPE
        FROM CV.CRAT
        ORDER BY CRAT_TYPE
    </select>

    <!--
        依多條件查詢佣金率

        注意：此方法應搭配 PageHelper.startPage() 使用以支援分頁。
    -->
    <select id="search" resultType="com.vlife.cv.commission.Crat">
        SELECT <include refid="commissionRateColumns"/>
        FROM CV.CRAT
        <where>
            <if test="commClassCode != null">
                AND COMM_CLASS_CODE = #{commClassCode}
            </if>
            <if test="commLineCode != null">
                AND COMM_LINE_CODE = #{commLineCode}
            </if>
            <if test="cratType != null">
                AND CRAT_TYPE = #{cratType}
            </if>
            <if test="effectiveDate != null">
                AND STR_DATE &lt;= #{effectiveDate}
                AND END_DATE &gt;= #{effectiveDate}
            </if>
        </where>
        ORDER BY COMM_CLASS_CODE, COMM_LINE_CODE, STR_DATE DESC
    </select>

    <!--
        計算指定佣金類別碼的資料筆數
    -->
    <select id="countByClassCode" resultType="int">
        SELECT COUNT(*)
        FROM CV.CRAT
        WHERE COMM_CLASS_CODE = #{commClassCode}
    </select>

    <!-- ==================== CUD 操作 (CV004M) ==================== -->

    <!--
        取得下一個序號
        注意：使用 Oracle DUAL 表格和序列
    -->
    <select id="nextSerial" resultType="long">
        SELECT CV.CRAT_SEQ.NEXTVAL FROM DUAL
    </select>

    <!--
        新增佣金率 (cv004m_insert_crat)
    -->
    <insert id="insert">
        INSERT INTO CV.CRAT (
            CRAT_SERIAL,
            COMM_CLASS_CODE,
            COMM_LINE_CODE,
            CRAT_TYPE,
            PROJ_NO,
            STR_DATE,
            END_DATE,
            CRAT_KEY1,
            CRAT_KEY2,
            COMM_START_YEAR,
            COMM_END_YEAR,
            COMM_START_AGE,
            COMM_END_AGE,
            COMM_START_MODX,
            COMM_END_MODX,
            COMM_RATE,
            COMM_RATE_ORG,
            PREM_LIMIT_STR,
            PREM_LIMIT_END
        ) VALUES (
            #{serial},
            #{commClassCode},
            #{commLineCode},
            #{cratType},
            #{projectNo,jdbcType=VARCHAR},
            #{startDate},
            #{endDate},
            #{cratKey1},
            #{cratKey2},
            #{commStartYear},
            #{commEndYear},
            #{commStartAge},
            #{commEndAge},
            #{commStartModx,jdbcType=NUMERIC},
            #{commEndModx,jdbcType=NUMERIC},
            #{commRate},
            #{commRateOrg},
            #{premLimitStart,jdbcType=DECIMAL},
            #{premLimitEnd,jdbcType=DECIMAL}
        )
    </insert>

    <!--
        更新佣金率 (cv004m_update_crat)
        使用動態 SQL 只更新有值的欄位
    -->
    <update id="update">
        UPDATE CV.CRAT
        <set>
            <if test="req.commLineCode != null">COMM_LINE_CODE = #{req.commLineCode},</if>
            <if test="req.cratType != null">CRAT_TYPE = #{req.cratType},</if>
            <if test="req.projectNo != null">PROJ_NO = #{req.projectNo},</if>
            <if test="req.startDate != null">STR_DATE = #{req.startDate},</if>
            <if test="req.endDate != null">END_DATE = #{req.endDate},</if>
            <if test="req.cratKey1 != null">CRAT_KEY1 = #{req.cratKey1},</if>
            <if test="req.cratKey2 != null">CRAT_KEY2 = #{req.cratKey2},</if>
            <if test="req.commStartYear != null">COMM_START_YEAR = #{req.commStartYear},</if>
            <if test="req.commEndYear != null">COMM_END_YEAR = #{req.commEndYear},</if>
            <if test="req.commStartAge != null">COMM_START_AGE = #{req.commStartAge},</if>
            <if test="req.commEndAge != null">COMM_END_AGE = #{req.commEndAge},</if>
            <if test="req.commStartModx != null">COMM_START_MODX = #{req.commStartModx},</if>
            <if test="req.commEndModx != null">COMM_END_MODX = #{req.commEndModx},</if>
            <if test="req.commRate != null">COMM_RATE = #{req.commRate},</if>
            <if test="req.commRateOrg != null">COMM_RATE_ORG = #{req.commRateOrg},</if>
            <if test="req.premLimitStart != null">PREM_LIMIT_STR = #{req.premLimitStart},</if>
            <if test="req.premLimitEnd != null">PREM_LIMIT_END = #{req.premLimitEnd},</if>
        </set>
        WHERE CRAT_SERIAL = #{serial}
    </update>

    <!--
        刪除佣金率 (cv004m_delete_crat)
    -->
    <delete id="deleteBySerial">
        DELETE FROM CV.CRAT
        WHERE CRAT_SERIAL = #{serial}
    </delete>

    <!--
        檢查 key 值重疊 (cv004m_check_crat_key)

        檢查規則 (來自 V3 pk_cv_cv004m)：
        - 相同 commClassCode, commLineCode, cratType, projectNo
        - 日期範圍重疊：end_date >= 新的 start_date AND start_date <= 新的 end_date
        - key1/key2 範圍重疊：crat_key2 >= 新的 key1 AND crat_key1 <= 新的 key2
    -->
    <select id="countOverlapping" resultType="int">
        SELECT COUNT(*)
        FROM CV.CRAT
        WHERE COMM_CLASS_CODE = #{commClassCode}
          AND COMM_LINE_CODE = #{commLineCode}
          AND CRAT_TYPE = #{cratType}
          <choose>
              <when test="projectNo != null">AND PROJ_NO = #{projectNo}</when>
              <otherwise>AND PROJ_NO IS NULL</otherwise>
          </choose>
          AND END_DATE &gt;= #{startDate}
          AND STR_DATE &lt;= #{endDate}
          AND CRAT_KEY2 &gt;= #{cratKey1}
          AND CRAT_KEY1 &lt;= #{cratKey2}
          <if test="excludeSerial != null">
              AND CRAT_SERIAL != #{excludeSerial}
          </if>
    </select>

</mapper>
